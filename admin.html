<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUNLET í†µí•© ê´€ë¦¬ì V3</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background: #111; color: white; font-family: 'Noto Sans KR'; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { width: 500px; background: #222; padding: 30px; border-radius: 20px; box-shadow: 0 0 20px rgba(0,255,157,0.2); border: 1px solid #333; }
        h2 { text-align: center; color: #00ff9d; margin-bottom: 30px; }
        
        .section { margin-bottom: 25px; padding: 15px; background: #2a2a2a; border-radius: 10px; border: 1px solid #444; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #ccc; font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; background: #111; border: 1px solid #555; color: white; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; }
        
        button { width: 100%; padding: 15px; background: #00ff9d; color: black; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        button:hover { background: #00cc7d; }
        
        .status { margin-top: 20px; padding: 15px; background: #333; border-radius: 8px; font-size: 0.9rem; color: #aaa; word-break: break-all; display: none; }
        .current-info { font-size: 0.8rem; color: #00ff9d; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <h2>ğŸ”§ FUNLET ë°°ë„ˆ ê´€ë¦¬ì</h2>

        <div class="form-group" style="margin-bottom: 20px;">
            <label>ğŸ”‘ ê´€ë¦¬ì í† í°</label>
            <input type="password" id="token" placeholder="ghp_..." onchange="saveToken()">
        </div>

        <div class="section">
            <label>1. ìˆ˜ì •í•  ë°°ë„ˆ ì„ íƒ</label>
            <select id="bannerSelect" onchange="loadCurrentData()">
                <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>
                <option value="mainTop">ğŸ–¥ï¸ ë©”ì¸ ìƒë‹¨ ë°°ë„ˆ (PC)</option>
                <option value="sidebar">â– ì‚¬ì´ë“œë°” ë°°ë„ˆ</option>
                <option value="gameBottom">ğŸ“± ê²Œì„ í•˜ë‹¨ ë°°ë„ˆ (ëª¨ë°”ì¼)</option>
                <option value="hero">âœ¨ ë©”ì¸ íƒ€ì´í‹€ ë°°ê²½ (Hero)</option>
            </select>
            <div id="currentData" class="current-info"></div>
        </div>

        <div class="section">
            <label>2. ì—°ê²°í•  ì£¼ì†Œ (ë§í¬ URL)</label>
            <input type="text" id="linkUrl" placeholder="ì˜ˆ: https://google.com">
            
            <label style="margin-top:15px;">3. ìƒˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì„ íƒì‚¬í•­)</label>
            <input type="file" id="fileInput" accept="image/*">
            <p style="font-size:0.8rem; color:#888;">* ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ë§í¬ë§Œ ìˆ˜ì •ë©ë‹ˆë‹¤.</p>
        </div>

        <button onclick="updateBanner()" id="uploadBtn">ì €ì¥í•˜ê¸°</button>
        <div class="status" id="statusBox"></div>
    </div>

    <script>
        const USER = 'fun-let';
        const REPO = 'funlet';
        
        // ë‚´ë¶€ ê´€ë¦¬ìš© íŒŒì¼ëª… ë§¤í•‘
        const FILE_MAP = {
            'mainTop': 'banner_main_pc.png',
            'sidebar': 'banner_sidebar.png',
            'gameBottom': 'banner_game_bottom.png',
            'hero': 'bg_hero.png'
        };

        let currentJsonData = {}; // ë¶ˆëŸ¬ì˜¨ JSON ë°ì´í„° ì„ì‹œ ì €ì¥
        let currentSha = null;    // JSON íŒŒì¼ì˜ SHA (ìˆ˜ì • ê¶Œí•œìš©)

        window.onload = () => {
            const savedToken = localStorage.getItem('github_token');
            if(savedToken) document.getElementById('token').value = savedToken;
            fetchJsonData(); // ì ‘ì†í•˜ìë§ˆì í˜„ì¬ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        }

        function saveToken() {
            localStorage.setItem('github_token', document.getElementById('token').value);
            fetchJsonData();
        }

        // GitHubì—ì„œ í˜„ì¬ JSON ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function fetchJsonData() {
            const token = document.getElementById('token').value;
            if(!token) return;

            try {
                const url = `https://api.github.com/repos/${USER}/${REPO}/contents/data/ads.json`;
                const response = await fetch(url, { headers: { Authorization: `token ${token}` } });
                const data = await response.json();
                
                currentSha = data.sha;
                // Base64 ë””ì½”ë”© (í•œê¸€ ê¹¨ì§ ë°©ì§€)
                const decodedContent = new TextDecoder().decode(Uint8Array.from(atob(data.content), c => c.charCodeAt(0)));
                currentJsonData = JSON.parse(decodedContent);
                console.log("ë°ì´í„° ë¡œë“œ ì™„ë£Œ:", currentJsonData);
            } catch (e) {
                console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", e);
            }
        }

        // ì„ íƒ ì‹œ í˜„ì¬ ìƒíƒœ í‘œì‹œ
        function loadCurrentData() {
            const key = document.getElementById('bannerSelect').value;
            const linkInput = document.getElementById('linkUrl');
            const infoBox = document.getElementById('currentData');

            if (key && currentJsonData[key]) {
                linkInput.value = currentJsonData[key].link || "";
                infoBox.innerText = `í˜„ì¬ ë§í¬: ${currentJsonData[key].link || "ì—†ìŒ"}`;
            } else {
                linkInput.value = "";
                infoBox.innerText = "";
            }
        }

        // [í•µì‹¬] ì—…ë°ì´íŠ¸ ì‹¤í–‰
        async function updateBanner() {
            const token = document.getElementById('token').value;
            const key = document.getElementById('bannerSelect').value;
            const linkUrl = document.getElementById('linkUrl').value;
            const fileInput = document.getElementById('fileInput');
            const statusBox = document.getElementById('statusBox');
            const btn = document.getElementById('uploadBtn');

            if (!key) { alert("ìˆ˜ì •í•  ë°°ë„ˆë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

            btn.disabled = true;
            statusBox.style.display = 'block';
            statusBox.innerText = "ì²˜ë¦¬ ì¤‘...";

            try {
                let imageUrl = currentJsonData[key]?.image || "";

                // 1. ì´ë¯¸ì§€ê°€ ì„ íƒë˜ì—ˆë‹¤ë©´ ë¨¼ì € ì—…ë¡œë“œ
                if (fileInput.files.length > 0) {
                    statusBox.innerText = "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...";
                    const file = fileInput.files[0];
                    const fileName = FILE_MAP[key];
                    const content = await readFileAsBase64(file);
                    
                    // ì´ë¯¸ì§€ ì—…ë¡œë“œ API í˜¸ì¶œ
                    await uploadFileToGitHub(token, `images/${fileName}`, content);
                    
                    // ìƒˆ ì´ë¯¸ì§€ ì£¼ì†Œ ìƒì„± (ìºì‹œ ë°©ì§€ ì¶”ê°€)
                    imageUrl = `https://${USER}.github.io/${REPO}/images/${fileName}?v=${new Date().getTime()}`;
                }

                // 2. JSON ë°ì´í„° ì—…ë°ì´íŠ¸
                statusBox.innerText = "ì„¤ì • ì €ì¥ ì¤‘...";
                
                // ë°ì´í„° ìˆ˜ì •
                if (!currentJsonData[key]) currentJsonData[key] = {};
                currentJsonData[key].link = linkUrl;
                currentJsonData[key].image = imageUrl;

                // JSON íŒŒì¼ ì—…ë¡œë“œ
                const jsonContent = btoa(unescape(encodeURIComponent(JSON.stringify(currentJsonData, null, 2))));
                await uploadFileToGitHub(token, 'data/ads.json', jsonContent, currentSha);

                // SHA ê°±ì‹  (ì—°ì† ìˆ˜ì •ì„ ìœ„í•´)
                await fetchJsonData();

                statusBox.innerHTML = `âœ… <b>ì™„ë£Œ!</b><br>ì´ë¯¸ì§€ì™€ ë§í¬ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ì•½ 1ë¶„ ë’¤ ì‚¬ì´íŠ¸ì— ë°˜ì˜ë©ë‹ˆë‹¤.`;
                alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");

            } catch (error) {
                statusBox.innerText = "âŒ ì˜¤ë¥˜: " + error.message;
            } finally {
                btn.disabled = false;
            }
        }

        // íŒŒì¼ ì½ê¸° í—¬í¼
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        // GitHub ì—…ë¡œë“œ í—¬í¼
        async function uploadFileToGitHub(token, path, content, sha = null) {
            let fileSha = sha;
            
            // SHAê°€ ì—†ìœ¼ë©´(ì´ë¯¸ì§€ ë®ì–´ì“°ê¸° ì‹œ) ë¨¼ì € íŒŒì¼ ì •ë³´ë¥¼ ì¡°íšŒí•´ì„œ SHAë¥¼ ì–»ìŒ
            if (!fileSha) {
                try {
                    const check = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${path}`, {
                        headers: { Authorization: `token ${token}` }
                    });
                    if (check.ok) {
                        const data = await check.json();
                        fileSha = data.sha;
                    }
                } catch (e) {}
            }

            const bodyData = {
                message: `Update ${path} via Admin`,
                content: content
            };
            if (fileSha) bodyData.sha = fileSha;

            const res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${path}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(bodyData)
            });

            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.message);
            }
        }
    </script>
</body>
</html>
