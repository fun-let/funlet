<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUNLET ë§ˆìŠ¤í„° ê´€ë¦¬ì V5</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background: #111; color: white; font-family: 'Noto Sans KR'; padding: 20px; margin: 0; }
        .container { max-width: 800px; margin: 0 auto; background: #222; padding: 30px; border-radius: 20px; border: 1px solid #333; }
        h2 { text-align: center; color: #00ff9d; margin-bottom: 30px; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #ccc; }
        input, select { width: 100%; padding: 12px; background: #333; border: 1px solid #555; color: white; border-radius: 8px; box-sizing: border-box; }
        
        /* íƒ­ ë””ìì¸ */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .tab-btn { flex: 1; padding: 10px; background: transparent; border: none; color: #888; cursor: pointer; font-size: 1.1rem; font-weight: bold; transition:0.3s; }
        .tab-btn:hover { color: white; }
        .tab-btn.active { color: #00ff9d; border-bottom: 3px solid #00ff9d; }
        
        /* íŒŒì¼ ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ë“œ */
        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 15px; max-height: 400px; overflow-y: auto; }
        .file-card { background: #2a2a2a; border: 1px solid #444; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer; transition: 0.2s; }
        .file-card:hover, .file-card.selected { border-color: #00ff9d; background: #333; }
        .file-card img { width: 100%; height: 80px; object-fit: contain; background: #000; border-radius: 5px; margin-bottom: 5px; }
        .file-name { font-size: 0.75rem; color: #ddd; word-break: break-all; }
        
        /* ë§í¬ ì—ë””í„° ìŠ¤íƒ€ì¼ */
        .link-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; background: #2a2a2a; padding: 10px; border-radius: 8px; }
        .link-key { width: 30%; font-weight: bold; color: #00ff9d; font-size: 0.9rem; }
        
        button.action-btn { width: 100%; padding: 15px; background: #00ff9d; color: black; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1rem; margin-top: 20px; }
        button.action-btn:hover { background: #00cc7d; }

        .hidden { display: none; }
        .loading { text-align: center; color: #888; padding: 20px; }
        .info-txt { font-size: 0.8rem; color: #aaa; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="container">
        <h2>ğŸ”§ FUNLET ë§ˆìŠ¤í„° ê´€ë¦¬ì V5</h2>

        <div class="form-group">
            <label>ğŸ”‘ ê´€ë¦¬ì í† í°</label>
            <input type="password" id="token" placeholder="ghp_..." onchange="saveToken()">
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('overwrite')">ğŸ”„ ì´ë¯¸ì§€ êµì²´</button>
            <button class="tab-btn" onclick="switchTab('new')">â• ì‹ ê·œ ì—…ë¡œë“œ</button>
            <button class="tab-btn" onclick="switchTab('links')">ğŸ”— ë°°ë„ˆ ë§í¬</button>
        </div>

        <div id="folderSection" class="form-group">
            <label>ğŸ“‚ í´ë” ì„ íƒ (ìë™ ìŠ¤ìº”)</label>
            <select id="folderSelect" onchange="loadFiles(this.value)">
                <option value="">í† í° í™•ì¸ ì¤‘...</option>
            </select>
            <button onclick="scanFolders()" style="margin-top:5px; background:#444; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">ğŸ”„ í´ë” ìƒˆë¡œê³ ì¹¨</button>
        </div>

        <div id="tab-overwrite">
            <label>ëŒ€ìƒ íŒŒì¼ ì„ íƒ</label>
            <div id="fileGrid" class="file-grid">
                <div class="loading">í´ë”ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
            </div>
            <input type="hidden" id="selectedOverwriteName">
        </div>

        <div id="tab-new" class="hidden">
            <label>âœ¨ ìƒˆë¡œ ë§Œë“¤ íŒŒì¼ëª… (ì˜ì–´ ì†Œë¬¸ì ê¶Œì¥)</label>
            <input type="text" id="newFileName" placeholder="ì˜ˆ: new_game_thumb.jpg">
            <p class="info-txt">* í™•ì¥ì(.png, .jpg)ê¹Œì§€ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
        </div>

        <div id="uploadSection" class="form-group" style="margin-top: 20px; border-top: 1px solid #444; padding-top: 20px;">
            <label>ğŸ–¼ï¸ ì—…ë¡œë“œí•  ì´ë¯¸ì§€ ì„ íƒ</label>
            <input type="file" id="fileInput" accept="image/*">
            <button class="action-btn" onclick="uploadImage()" id="uploadBtn">ì„œë²„ì— ì „ì†¡í•˜ê¸°</button>
            <div id="statusBox" style="margin-top:10px; color:#ff6b6b; display:none;"></div>
        </div>

        <div id="tab-links" class="hidden">
            <div id="linkList">
                <div class="loading">ë°ì´í„° ë¡œë”© ì¤‘...</div>
            </div>
            <button class="action-btn" onclick="saveLinks()">ëª¨ë“  ë§í¬ ì €ì¥í•˜ê¸°</button>
        </div>

    </div>

    <script>
        const USER = 'fun-let';
        const REPO = 'funlet';
        let currentPath = '';
        let currentTab = 'overwrite';
        let currentAdsData = {};
        let adsSha = null;

        window.onload = () => {
            const t = localStorage.getItem('github_token');
            if(t) {
                document.getElementById('token').value = t;
                scanFolders();
            }
        }

        function saveToken() {
            localStorage.setItem('github_token', document.getElementById('token').value);
            scanFolders();
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            const folderSec = document.getElementById('folderSection');
            const upSec = document.getElementById('uploadSection');
            const tabOver = document.getElementById('tab-overwrite');
            const tabNew = document.getElementById('tab-new');
            const tabLinks = document.getElementById('tab-links');

            if(tab === 'links') {
                folderSec.classList.add('hidden');
                upSec.classList.add('hidden');
                tabOver.classList.add('hidden');
                tabNew.classList.add('hidden');
                tabLinks.classList.remove('hidden');
                loadLinks();
            } else {
                folderSec.classList.remove('hidden');
                upSec.classList.remove('hidden');
                tabLinks.classList.add('hidden');
                
                if(tab === 'overwrite') {
                    tabOver.classList.remove('hidden');
                    tabNew.classList.add('hidden');
                    document.getElementById('uploadBtn').innerText = "ì„ íƒí•œ íŒŒì¼ ë®ì–´ì“°ê¸°";
                } else {
                    tabOver.classList.add('hidden');
                    tabNew.classList.remove('hidden');
                    document.getElementById('uploadBtn').innerText = "ìƒˆ íŒŒì¼ ìƒì„±í•˜ê¸°";
                }
            }
        }

        // --- ê¸°ëŠ¥ 1: í´ë”/íŒŒì¼ ê´€ë¦¬ ---

        async function scanFolders() {
            const token = document.getElementById('token').value;
            if(!token) return;
            const select = document.getElementById('folderSelect');
            
            try {
                const url = `https://api.github.com/repos/${USER}/${REPO}/contents/images`;
                const res = await fetch(url, { headers: { Authorization: `token ${token}` } });
                const data = await res.json();

                select.innerHTML = '<option value="">-- í´ë” ì„ íƒ --</option>';
                select.innerHTML += `<option value="images/">images/ (ê¸°ë³¸)</option>`;
                
                data.forEach(item => {
                    if(item.type === 'dir') {
                        select.innerHTML += `<option value="${item.path}/">${item.path}/</option>`;
                    }
                });
            } catch(e) {
                console.error(e);
            }
        }

        async function loadFiles(path) {
            if(!path) return;
            currentPath = path;
            const token = document.getElementById('token').value;
            const grid = document.getElementById('fileGrid');
            grid.innerHTML = '<div class="loading">ë¡œë”© ì¤‘...</div>';

            try {
                const url = `https://api.github.com/repos/${USER}/${REPO}/contents/${path}`;
                const res = await fetch(url, { headers: { Authorization: `token ${token}` } });
                const data = await res.json();

                grid.innerHTML = '';
                data.forEach(item => {
                    if(item.type === 'file' && item.name.match(/\.(jpg|jpeg|png|gif)$/i)) {
                        const card = document.createElement('div');
                        card.className = 'file-card';
                        card.onclick = () => selectFileCard(card, item.name);
                        card.innerHTML = `<img src="${item.download_url}?t=${Date.now()}"><div class="file-name">${item.name}</div>`;
                        grid.appendChild(card);
                    }
                });
                if(grid.innerHTML === '') grid.innerHTML = '<div class="loading">ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            } catch(e) { grid.innerHTML = 'ë¡œë“œ ì‹¤íŒ¨'; }
        }

        function selectFileCard(card, name) {
            document.querySelectorAll('.file-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            document.getElementById('selectedOverwriteName').value = name;
        }

        async function uploadImage() {
            const token = document.getElementById('token').value;
            const fileInput = document.getElementById('fileInput');
            const statusBox = document.getElementById('statusBox');
            
            let fileName = "";
            
            if(currentTab === 'overwrite') {
                fileName = document.getElementById('selectedOverwriteName').value;
                if(!fileName) { alert("êµì²´í•  íŒŒì¼ì„ ëª©ë¡ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
            } else {
                fileName = document.getElementById('newFileName').value;
                if(!fileName) { alert("ìƒˆ íŒŒì¼ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            }

            if(fileInput.files.length === 0) { alert("ì—…ë¡œë“œí•  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

            const file = fileInput.files[0];
            const fullPath = currentPath + fileName;
            const btn = document.getElementById('uploadBtn');
            
            btn.disabled = true;
            statusBox.style.display = 'block';
            statusBox.innerText = "ì—…ë¡œë“œ ì¤‘...";

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async function() {
                const content = reader.result.split(',')[1];
                
                // SHA ì¡°íšŒ (ë®ì–´ì“°ê¸°ìš©)
                let sha = null;
                try {
                    const check = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${fullPath}`, {
                        headers: { Authorization: `token ${token}` }
                    });
                    if(check.ok) {
                        const d = await check.json();
                        sha = d.sha;
                    }
                } catch(e) {}

                // ì‹ ê·œì¸ë° íŒŒì¼ì´ ìˆìœ¼ë©´ ê²½ê³ 
                if(currentTab === 'new' && sha) {
                    if(!confirm("ì´ë¯¸ ê°™ì€ ì´ë¦„ì˜ íŒŒì¼ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        btn.disabled = false; statusBox.innerText = "ì·¨ì†Œë¨"; return;
                    }
                }

                const bodyData = { message: `Update ${fileName}`, content: content };
                if(sha) bodyData.sha = sha;

                try {
                    const res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${fullPath}`, {
                        method: 'PUT',
                        headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify(bodyData)
                    });

                    if(res.ok) {
                        const resData = await res.json();
                        // ê²°ê³¼ í‘œì‹œ (ì£¼ì†Œ ë³µì‚¬ ê¸°ëŠ¥ ì¶”ê°€)
                        const fileUrl = `./${fullPath}`;
                        statusBox.innerHTML = `âœ… ì„±ê³µ!<br>íŒŒì¼ëª…: <b>${fileName}</b><br>ì½”ë“œìš© ì£¼ì†Œ: <span style="color:#00ff9d; user-select:all;">${fileUrl}</span>`;
                        alert("ì—…ë¡œë“œ ì™„ë£Œ! (1~2ë¶„ ì†Œìš”)");
                        if(currentTab === 'new') loadFiles(currentPath); // ëª©ë¡ ê°±ì‹ 
                    } else {
                        const err = await res.json();
                        statusBox.innerText = "ì‹¤íŒ¨: " + err.message;
                    }
                } catch(e) { statusBox.innerText = "ì˜¤ë¥˜: " + e; }
                btn.disabled = false;
            };
        }

        // --- ê¸°ëŠ¥ 2: ë§í¬ ê´€ë¦¬ --- (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        async function loadLinks() {
            const token = document.getElementById('token').value;
            const list = document.getElementById('linkList');
            list.innerHTML = '<div class="loading">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            try {
                const url = `https://api.github.com/repos/${USER}/${REPO}/contents/data/ads.json`;
                const res = await fetch(url, { headers: { Authorization: `token ${token}` } });
                const data = await res.json();
                
                adsSha = data.sha;
                const decoded = new TextDecoder().decode(Uint8Array.from(atob(data.content), c => c.charCodeAt(0)));
                currentAdsData = JSON.parse(decoded);

                list.innerHTML = '';
                for (const [key, value] of Object.entries(currentAdsData)) {
                    // í‚¤ ì´ë¦„ í•œê¸€í™”
                    let label = key;
                    if(key === 'hero') label = 'ë©”ì¸ íƒ€ì´í‹€ ë°°ê²½';
                    if(key === 'mainTop') label = 'ë©”ì¸ ìƒë‹¨ ë°°ë„ˆ';
                    if(key === 'gameBottom') label = 'ê²Œì„ í•˜ë‹¨ ë°°ë„ˆ';
                    if(key === 'sidebar') label = 'ì‚¬ì´ë“œë°” ë°°ë„ˆ';

                    const row = document.createElement('div');
                    row.className = 'link-row';
                    row.innerHTML = `
                        <div class="link-key">${label}</div>
                        <input type="text" id="link-${key}" value="${value.link || '#'}" placeholder="URL ì…ë ¥">
                    `;
                    list.appendChild(row);
                }
            } catch(e) { list.innerHTML = 'ë¡œë“œ ì‹¤íŒ¨'; }
        }

        async function saveLinks() {
            const token = document.getElementById('token').value;
            for (const key of Object.keys(currentAdsData)) {
                const input = document.getElementById(`link-${key}`);
                if(input) currentAdsData[key].link = input.value;
            }

            try {
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(currentAdsData, null, 2))));
                const url = `https://api.github.com/repos/${USER}/${REPO}/contents/data/ads.json`;
                
                const res = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: "Update Links", content: content, sha: adsSha })
                });

                if(res.ok) {
                    const d = await res.json();
                    adsSha = d.content.sha;
                    alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                } else { alert("ì €ì¥ ì‹¤íŒ¨"); }
            } catch(e) { alert("ì˜¤ë¥˜: " + e); }
        }
    </script>
</body>
</html>
