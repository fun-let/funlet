<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUNLET Admin V10</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --sidebar-w: 260px; --primary: #00ff9d; --bg: #121212; --panel: #1e1e1e; --danger: #ff4757; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: 'Noto Sans KR'; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: var(--sidebar-w); background: #1a1a1a; border-right: 1px solid #333; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; flex-shrink: 0; }
        .logo { font-size: 1.5rem; color: var(--primary); font-weight: bold; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .menu-item { padding: 15px; color: #aaa; cursor: pointer; border-radius: 10px; margin-bottom: 5px; transition: 0.2s; display: flex; align-items: center; gap: 10px; font-weight: 500; }
        .menu-item:hover, .menu-item.active { background: rgba(0, 255, 157, 0.1); color: var(--primary); }
        
        .content { flex: 1; padding: 40px; overflow-y: auto; background: var(--bg); position: relative; }
        .page { display: none; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 { border-bottom: 2px solid #333; padding-bottom: 15px; margin-top: 0; color: var(--primary); }
        .card { background: #222; padding: 20px; border-radius: 10px; border: 1px solid #333; margin-bottom: 20px; }
        
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #ccc; font-size: 0.9rem; }
        input, select, textarea { width: 100%; padding: 12px; background: #111; border: 1px solid #444; color: white; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; font-family: 'Noto Sans KR'; }
        textarea { font-family: 'Consolas', monospace; line-height: 1.5; background: #0f0f0f; color: #a6e22e; } /* ì½”ë“œ ì—ë””í„° ëŠë‚Œ */
        input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: none; }
        
        button { padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; border: none; font-size: 0.9rem; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: black; width: 100%; padding: 15px; font-size: 1.1rem; }
        .btn-primary:hover { background: #00cc7d; }
        .btn-danger { background: var(--danger); color: white; width: auto; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; width: auto; background: #444; color: white; }

        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-top: 15px; }
        .file-card { background: #2a2a2a; border: 1px solid #444; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer; transition: 0.2s; position: relative; }
        .file-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .file-card img { width: 100%; height: 80px; object-fit: contain; background: #000; border-radius: 5px; margin-bottom: 5px; }
        .file-icon { font-size: 3rem; color: #666; margin-bottom: 10px; display: block; }
        .file-name { font-size: 0.75rem; color: #ddd; word-break: break-all; }

        .loading { text-align: center; color: #888; padding: 20px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo"><i class="fa-solid fa-gamepad"></i> FUNLET ADMIN</div>
        
        <div class="menu-item active" onclick="goPage('game')"><i class="fa-solid fa-code"></i> ê²Œì„/ì½”ë“œ ê´€ë¦¬</div>
        <div class="menu-item" onclick="goPage('category')"><i class="fa-solid fa-list"></i> ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</div>
        <div class="menu-item" onclick="goPage('assets')"><i class="fa-solid fa-folder-open"></i> ìì‚°(ì´ë¯¸ì§€/ì†Œë¦¬)</div>
        <div class="menu-item" onclick="goPage('link')"><i class="fa-solid fa-link"></i> ë°°ë„ˆ ë§í¬</div>

        <div style="margin-top:auto;">
            <label>ğŸ”‘ ê´€ë¦¬ì í† í°</label>
            <input type="password" id="token" placeholder="ghp_..." onchange="saveToken()">
            <button onclick="loadAllData()" class="btn-primary" style="margin-top:10px; background:#444; color:white; font-size:0.9rem;">ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
        </div>
    </div>

    <div class="content">

        <div id="page-game" class="page active">
            <h2>ğŸ® ê²Œì„ ì •ë³´ ë° ì½”ë“œ ìˆ˜ì •</h2>
            
            <div class="card">
                <div class="form-group">
                    <label>ìˆ˜ì •í•  ê²Œì„ ì„ íƒ (ì‹ ê·œ ìƒì„±ì€ ë§¨ ìœ„ ì„ íƒ)</label>
                    <select id="gameSelector" onchange="selectGameForEdit()">
                        <option value="">-- ì‹ ê·œ ê²Œì„ ë§Œë“¤ê¸° --</option>
                    </select>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div>
                        <label>ê²Œì„ ID (í´ë”ëª…, ë„ì–´ì“°ê¸° ê¸ˆì§€)</label>
                        <input type="text" id="gId" placeholder="ì˜ˆ: space-merge">
                    </div>
                    <div>
                        <label>ê²Œì„ ì œëª©</label>
                        <input type="text" id="gTitle" placeholder="ì˜ˆ: ìš°ì£¼ í•©ì¹˜ê¸°">
                    </div>
                </div>

                <label>ì¹´í…Œê³ ë¦¬</label>
                <select id="gCategory"><option>ë¡œë”© ì¤‘...</option></select>

                <label>ì¸ë„¤ì¼ ê²½ë¡œ</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="gThumbPath" placeholder="ì´ë¯¸ì§€ ê²½ë¡œ">
                    <button class="btn-sm" onclick="alert('ìì‚° íƒ­ì—ì„œ ì—…ë¡œë“œ í›„ ê²½ë¡œë¥¼ ë³µì‚¬í•´ì˜¤ì„¸ìš”!')">ì°¾ê¸°</button>
                </div>

                <hr style="border:0; border-top:1px solid #444; margin: 20px 0;">

                <label>ğŸ’» ê²Œì„ HTML ì½”ë“œ (ì—¬ê¸°ì„œ ì§ì ‘ ìˆ˜ì •í•˜ì„¸ìš”)</label>
                <textarea id="gCode" style="height: 400px;" placeholder="ê²Œì„ì„ ì„ íƒí•˜ë©´ ì½”ë“œë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤..."></textarea>
                <div style="text-align:right; margin-top:5px; font-size:0.8rem; color:#aaa;">* ì €ì¥ ëˆ„ë¥´ë©´ index.html íŒŒì¼ì´ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.</div>

                <button class="btn-primary" onclick="saveGameData()" style="margin-top:20px;">ëª¨ë“  ë³€ê²½ì‚¬í•­ ì €ì¥ (ì½”ë“œ í¬í•¨)</button>
            </div>
        </div>

        <div id="page-category" class="page">
            <h2>ğŸ“‚ ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ <button class="btn-sm" onclick="addCategoryRow()">+ ì¶”ê°€</button></h2>
            <div id="categoryList"></div>
            <button class="btn-primary" onclick="saveCategories()">ë³€ê²½ì‚¬í•­ ì €ì¥</button>
        </div>

        <div id="page-assets" class="page">
            <h2>ğŸ–¼ï¸ ìì‚° ë° íŒŒì¼ ê´€ë¦¬</h2>
            <div class="card">
                <div style="display:flex; gap:10px;">
                    <select id="folderSelect" onchange="loadFolderFiles(this.value)" style="flex:1;">
                        <option value="">í´ë” ì„ íƒ...</option>
                    </select>
                    <button onclick="scanFolders()" class="btn-sm">ğŸ”„ ìŠ¤ìº”</button>
                </div>
            </div>
            
            <div class="card">
                <label>ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ (ëª¨ë“  í˜•ì‹ ê°€ëŠ¥)</label>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="text" id="uploadName" placeholder="íŒŒì¼ëª… (ì˜ˆ: bgm.mp3)" style="flex:1;">
                    <input type="file" id="uploadFile" style="flex:1;">
                </div>
                <button class="btn-primary" onclick="uploadAsset()" style="margin-top:10px; padding:10px;">ì—…ë¡œë“œ</button>
            </div>

            <div id="fileGrid" class="file-grid"></div>
        </div>

        <div id="page-link" class="page">
            <h2>ğŸ”— ë°°ë„ˆ ë§í¬ ê´€ë¦¬</h2>
            <div id="linkList"></div>
            <button class="btn-primary" onclick="saveLinks()" style="margin-top:20px;">ë§í¬ ì €ì¥</button>
        </div>

    </div>

    <script>
        const USER = 'fun-let';
        const REPO = 'funlet';
        let categories = [], games = [], adsData = {};
        let catsSha = null, gamesSha = null, adsSha = null;
        let currentPath = "";

        window.onload = () => {
            const t = localStorage.getItem('token');
            if(t) { document.getElementById('token').value = t; loadAllData(); }
        }
        function saveToken() { localStorage.setItem('token', document.getElementById('token').value); loadAllData(); }
        
        function goPage(p) {
            document.querySelectorAll('.menu-item').forEach(e=>e.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));
            document.getElementById('page-'+p).classList.add('active');
        }

        async function loadAllData() {
            const token = document.getElementById('token').value;
            if(!token) return;
            
            // ë°ì´í„° ë³‘ë ¬ ë¡œë“œ
            await Promise.all([loadCategories(), loadGames(), scanFolders(), loadLinks()]);
        }

        // --- 1. ê²Œì„ & ì½”ë“œ ê´€ë¦¬ ---
        async function loadGames() {
            const token = document.getElementById('token').value;
            try {
                let res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/data/games.json`, {headers:{Authorization:`token ${token}`}});
                let d = await res.json();
                gamesSha = d.sha;
                games = JSON.parse(decodeContent(d.content));
                updateGameSelector();
            } catch(e) { console.log("ê²Œì„ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨"); }
        }

        function updateGameSelector() {
            const sel = document.getElementById('gameSelector');
            sel.innerHTML = '<option value="">-- ì‹ ê·œ ê²Œì„ ë§Œë“¤ê¸° --</option>';
            games.forEach((g, idx) => {
                sel.innerHTML += `<option value="${idx}">[ìˆ˜ì •] ${g.title} (${g.id})</option>`;
            });
        }

        async function selectGameForEdit() {
            const idx = document.getElementById('gameSelector').value;
            const codeArea = document.getElementById('gCode');
            
            if(idx === "") {
                // ì‹ ê·œ ëª¨ë“œ
                document.getElementById('gId').value = "";
                document.getElementById('gId').disabled = false;
                document.getElementById('gTitle').value = "";
                document.getElementById('gThumbPath').value = "";
                codeArea.value = "";
            } else {
                // ìˆ˜ì • ëª¨ë“œ
                const g = games[idx];
                document.getElementById('gId').value = g.id;
                document.getElementById('gId').disabled = true; 
                document.getElementById('gTitle').value = g.title;
                document.getElementById('gCategory').value = g.category;
                document.getElementById('gThumbPath').value = g.thumb;
                
                // [í•µì‹¬] ì‹¤ì œ ê²Œì„ ì½”ë“œ(HTML) ë¶ˆëŸ¬ì˜¤ê¸°
                codeArea.value = "ì½”ë“œ ë¡œë”© ì¤‘...";
                try {
                    const token = document.getElementById('token').value;
                    const path = `games/${g.id}/index.html`;
                    const res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${path}`, {headers:{Authorization:`token ${token}`}});
                    
                    if(res.ok) {
                        const d = await res.json();
                        codeArea.value = decodeContent(d.content);
                    } else {
                        codeArea.value = "<!DOCTYPE html>\n<html>\n\n</html>";
                    }
                } catch(e) {
                    codeArea.value = "ì½”ë“œ ë¡œë“œ ì‹¤íŒ¨: " + e;
                }
            }
        }

        async function saveGameData() {
            const id = document.getElementById('gId').value;
            const title = document.getElementById('gTitle').value;
            const catId = document.getElementById('gCategory').value;
            const thumb = document.getElementById('gThumbPath').value;
            const code = document.getElementById('gCode').value;
            const token = document.getElementById('token').value;

            if(!id || !title || !code) return alert("í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

            // 1. games.json ì—…ë°ì´íŠ¸
            const catName = categories.find(c => c.id === catId)?.name || "ê¸°íƒ€";
            const newEntry = { id, title, category: catId, desc: catName, thumb };
            const idx = games.findIndex(g => g.id === id);
            
            if(idx > -1) games[idx] = newEntry; else games.push(newEntry);
            
            await uploadFile('data/games.json', JSON.stringify(games, null, 2), gamesSha, "Update Games List");

            // 2. index.html ì½”ë“œ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ íŒŒì¼ ì²´í¬ í›„ ë®ì–´ì“°ê¸°)
            let codeSha = null;
            try {
                const res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/games/${id}/index.html`, {headers:{Authorization:`token ${token}`}});
                if(res.ok) codeSha = (await res.json()).sha;
            } catch(e){}

            await uploadFile(`games/${id}/index.html`, code, codeSha, `Update game code ${id}`);
            
            alert("ì €ì¥ ì™„ë£Œ! ê²Œì„ ëª©ë¡ê³¼ ì½”ë“œê°€ ëª¨ë‘ ì—…ë°ì´íŠ¸ ë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadGames(); // ëª©ë¡ ê°±ì‹ 
        }

        // --- 2. ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ ---
        async function loadCategories() {
            const token = document.getElementById('token').value;
            try {
                let res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/data/categories.json`, {headers:{Authorization:`token ${token}`}});
                let d = await res.json();
                catsSha = d.sha;
                categories = JSON.parse(decodeContent(d.content));
                renderCats();
                const sel = document.getElementById('gCategory');
                sel.innerHTML = "";
                categories.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.name}</option>`);
            } catch(e) {}
        }
        function renderCats() {
            const list = document.getElementById('categoryList');
            list.innerHTML = "";
            categories.forEach((c, idx) => {
                list.innerHTML += `
                    <div class="list-row">
                        <input type="text" value="${c.id}" placeholder="ID" style="width:20%;" onchange="categories[${idx}].id=this.value">
                        <input type="text" value="${c.name}" placeholder="ì´ë¦„" style="width:40%;" onchange="categories[${idx}].name=this.value">
                        <input type="text" value="${c.icon}" placeholder="ì•„ì´ì½˜" style="width:30%;" onchange="categories[${idx}].icon=this.value">
                        <button class="btn-danger btn-sm" onclick="deleteCategory(${idx})">ì‚­ì œ</button>
                    </div>`;
            });
        }
        function addCategoryRow() { categories.push({id:"", name:"", icon:"fa-solid fa-gamepad"}); renderCats(); }
        function deleteCategory(idx) { if(confirm("ì‚­ì œ?")) { categories.splice(idx, 1); renderCats(); } }
        async function saveCategories() {
            await uploadFile('data/categories.json', JSON.stringify(categories, null, 2), catsSha, "Update Categories");
            alert("ì¹´í…Œê³ ë¦¬ ì €ì¥ ì™„ë£Œ!");
        }

        // --- 3. ìì‚° ê´€ë¦¬ (ëª¨ë“  íŒŒì¼ ë³´ê¸°) ---
        async function scanFolders() {
            const token = document.getElementById('token').value;
            const sel = document.getElementById('folderSelect');
            sel.innerHTML = '<option>ìŠ¤ìº” ì¤‘...</option>';
            try {
                // ë£¨íŠ¸, games, images, audio ìŠ¤ìº”
                const dirs = ['images', 'audio', 'games'];
                sel.innerHTML = '<option value="">-- í´ë” ì„ íƒ --</option>';
                
                for(let d of dirs) {
                    let res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${d}`, {headers:{Authorization:`token ${token}`}});
                    let data = await res.json();
                    sel.innerHTML += `<option value="${d}/">ğŸ“‚ ${d}/</option>`;
                    data.forEach(item => {
                        if(item.type === 'dir') sel.innerHTML += `<option value="${item.path}/">   â”” ${item.name}/</option>`;
                    });
                }
            } catch(e) { console.error(e); }
        }

        async function loadFolderFiles(path) {
            if(!path) return;
            currentPath = path;
            const token = document.getElementById('token').value;
            const grid = document.getElementById('fileGrid');
            grid.innerHTML = '<div class="loading">ë¡œë”© ì¤‘...</div>';

            try {
                const res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${path}`, {headers:{Authorization:`token ${token}`}});
                const data = await res.json();
                grid.innerHTML = '';
                
                data.forEach(item => {
                    if(item.type === 'file') {
                        const div = document.createElement('div');
                        div.className = 'file-card';
                        
                        if(item.name.match(/\.(png|jpg|jpeg|gif)$/i)) {
                            div.innerHTML = `<img src="${item.download_url}"><div class="file-name">${item.name}</div>`;
                        } else {
                            div.innerHTML = `<div class="file-icon"><i class="fa-regular fa-file"></i></div><div class="file-name">${item.name}</div>`;
                        }
                        
                        div.onclick = () => {
                            document.getElementById('uploadName').value = item.name;
                            if(confirm(`ê²½ë¡œë¥¼ ë³µì‚¬í• ê¹Œìš”?\n${item.path}`)) navigator.clipboard.writeText(item.path);
                        };
                        grid.appendChild(div);
                    }
                });
            } catch(e) { grid.innerHTML = 'ë¡œë“œ ì‹¤íŒ¨'; }
        }

        async function uploadAsset() {
            const name = document.getElementById('uploadName').value;
            const file = document.getElementById('uploadFile').files[0];
            if(!name || !file) return alert("í™•ì¸ í•„ìš”");
            
            const reader = new FileReader();
            reader.onload = async function() {
                const content = reader.result.split(',')[1];
                let sha = null;
                try {
                    let res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${currentPath}${name}`, {headers:{Authorization:`token ${document.getElementById('token').value}`}});
                    if(res.ok) sha = (await res.json()).sha;
                } catch(e){}
                
                await uploadFileRaw(currentPath + name, content, sha);
                alert("ì—…ë¡œë“œ ì„±ê³µ!");
                loadFolderFiles(currentPath);
            };
            reader.readAsDataURL(file);
        }

        // --- 4. ë§í¬ ê´€ë¦¬ ---
        async function loadLinks() {
            const token = document.getElementById('token').value;
            try {
                let res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/data/ads.json`, {headers:{Authorization:`token ${token}`}});
                let d = await res.json();
                adsSha = d.sha;
                adsData = JSON.parse(decodeContent(d.content));
                const list = document.getElementById('linkList');
                list.innerHTML = "";
                for(const [k,v] of Object.entries(adsData)) {
                    list.innerHTML += `<div class="list-row"><span class="link-key">${k}</span><input type="text" id="lnk-${k}" value="${v.link}" style="width:70%;"></div>`;
                }
            } catch(e){}
        }
        async function saveLinks() {
            for(const k of Object.keys(adsData)) adsData[k].link = document.getElementById(`lnk-${k}`).value;
            await uploadFile('data/ads.json', JSON.stringify(adsData, null, 2), adsSha, "Update Links");
            alert("ì €ì¥ ì™„ë£Œ!");
            loadLinks();
        }

        // --- ìœ í‹¸ë¦¬í‹° ---
        function decodeContent(base64) {
            return new TextDecoder().decode(Uint8Array.from(atob(base64), c => c.charCodeAt(0)));
        }
        function encodeContent(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }

        async function uploadFile(path, content, sha, msg) {
            const token = document.getElementById('token').value;
            const body = { message: msg, content: encodeContent(content) };
            if(sha) body.sha = sha;
            await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${path}`, {
                method: 'PUT', headers: {'Authorization':`token ${token}`}, body: JSON.stringify(body)
            });
        }
        async function uploadFileRaw(path, base64, sha) {
            const token = document.getElementById('token').value;
            const body = { message: "Asset Upload", content: base64 };
            if(sha) body.sha = sha;
            await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${path}`, {
                method: 'PUT', headers: {'Authorization':`token ${token}`}, body: JSON.stringify(body)
            });
        }
    </script>
</body>
</html>
