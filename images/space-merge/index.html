<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Space Merge - 행성 합치기</title>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #0f0f1a; overflow: hidden; font-family: 'Black Han Sans', sans-serif; touch-action: none; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #gameContainer { position: relative; width: 100%; max-width: 450px; height: 100vh; background: #161626; overflow: hidden; border-left: 2px solid #333; border-right: 2px solid #333; }
        .ui-header { position: absolute; top: 0; left: 0; width: 100%; padding: 15px; display: flex; justify-content: space-between; align-items: flex-start; z-index: 10; pointer-events: none; }
        .score-box { color: white; text-shadow: 2px 2px 0 #000; }
        .score-val { font-size: 2.5rem; color: #00ff9d; display: block;}
        .next-preview { width: 60px; height: 60px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #444; margin-top: 5px; }
        .next-preview img { max-width: 80%; max-height: 80%; }
        #gameOverScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 50; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; }
        .btn { background: #00ff9d; color: black; border: none; padding: 15px 40px; font-size: 1.5rem; border-radius: 50px; cursor: pointer; font-family: 'Black Han Sans'; margin-top: 20px; pointer-events: auto; }
        .ad-area { position: absolute; bottom: 0; left: 0; width: 100%; height: 100px; background: rgba(0,0,0,0.5); z-index: 20; display: flex; justify-content: center; align-items: center; pointer-events: auto; }
        .dead-line { position: absolute; top: 120px; left: 0; width: 100%; height: 2px; background: #ff4757; opacity: 0.5; z-index: 5; border-bottom: 1px dashed red;}
    </style>
</head>
<body>
    <div id="gameContainer">
        <div class="dead-line"></div>
        <div class="ui-header">
            <div class="score-box"><span class="score-val" id="scoreDisplay">0</span></div>
            <div class="next-box"><div class="next-preview"><img id="nextImg" src=""></div></div>
        </div>
        <div id="gameOverScreen">
            <h1 style="color:#ff4757; font-size:3.5rem;">GAME OVER</h1>
            <p style="font-size:1.5rem;">SCORE: <span id="finalScore">0</span></p>
            <button class="btn" onclick="location.reload()">RETRY</button>
            <a href="../../index.html" style="color:#aaa; margin-top:20px; display:block; text-decoration:none;">HOME</a>
        </div>
        <div id="world"></div>
        <div class="ad-area" id="ad-game-bottom"></div>
    </div>
    <audio id="bgm" src="../../audio/space-merge/bgm_space.mp3" loop></audio>
    <audio id="sfx-drop" src="../../audio/space-merge/sfx_drop.mp3"></audio>
    <audio id="sfx-merge" src="../../audio/space-merge/sfx_merge.mp3"></audio>
    <script src="../../js/ads.js"></script>
    <script>
        const Engine = Matter.Engine, Render = Matter.Render, Runner = Matter.Runner, Bodies = Matter.Bodies, Composite = Matter.Composite, Events = Matter.Events, World = Matter.World;
        
        // 이미지 경로 수정 (파일명 확인 필수)
        const PLANETS = [
            { r: 20, s: 10, img: 'planet_0.png' }, { r: 30, s: 20, img: 'planet_1.png' },
            { r: 40, s: 40, img: 'planet_2.png' }, { r: 50, s: 80, img: 'planet_3.png' },
            { r: 65, s: 160, img: 'planet_4.png' }, { r: 80, s: 320, img: 'planet_5.png' },
            { r: 95, s: 640, img: 'planet_6.png' }, { r: 110, s: 1280, img: 'planet_7.png' },
            { r: 125, s: 2560, img: 'planet_8.png' }, { r: 140, s: 5120, img: 'planet_9.png' },
            { r: 155, s: 10000, img: 'planet_10.png'}
        ];

        const container = document.getElementById('gameContainer');
        const width = container.clientWidth;
        const height = container.clientHeight;
        let score = 0, nextIdx = 0, currentBody = null, canDrop = true, isGameOver = false;

        const engine = Engine.create();
        const world = engine.world;
        const render = Render.create({ element: document.getElementById('world'), engine: engine, options: { width: width, height: height, wireframes: false, background: 'transparent' } });

        World.add(world, [
            Bodies.rectangle(width/2, height, width, 60, { isStatic: true, render: { fillStyle: '#222' } }),
            Bodies.rectangle(0, height/2, 10, height, { isStatic: true, render: { fillStyle: '#222' } }),
            Bodies.rectangle(width, height/2, 10, height, { isStatic: true, render: { fillStyle: '#222' } })
        ]);

        Render.run(render);
        const runner = Runner.create();
        Runner.run(runner, engine);

        function createPlanetBody(x, y, idx, isStatic) {
            const p = PLANETS[idx];
            return Bodies.circle(x, y, p.r, {
                label: 'planet',
                isStatic: isStatic,
                restitution: 0.3,
                render: { sprite: { texture: `../../images/space-merge/${p.img}`, xScale: (p.r*2)/100, yScale: (p.r*2)/100 } },
                plugin: { level: idx } // 레벨 정보 저장
            });
        }

        function setNext() {
            nextIdx = Math.floor(Math.random() * 4);
            document.getElementById('nextImg').src = `../../images/space-merge/${PLANETS[nextIdx].img}`;
        }

        function spawnReady() {
            if(isGameOver) return;
            const p = PLANETS[nextIdx];
            currentBody = createPlanetBody(width/2, 50, nextIdx, true);
            currentBody.isSleeping = true;
            World.add(world, currentBody);
            canDrop = true;
            setNext();
        }

        setNext(); spawnReady();

        const inputHandler = (x) => {
            if(isGameOver || !canDrop || !currentBody) return;
            const limit = PLANETS[nextIdx].r;
            if(x < limit) x = limit; if(x > width - limit) x = width - limit;
            Matter.Body.setPosition(currentBody, { x: x, y: 50 });
        };

        const dropHandler = () => {
            if(isGameOver || !canDrop || !currentBody) return;
            canDrop = false;
            Matter.Body.setStatic(currentBody, false);
            currentBody.isSleeping = false;
            try { document.getElementById('sfx-drop').play(); } catch(e){}
            currentBody = null;
            setTimeout(spawnReady, 500);
        };

        container.addEventListener('mousemove', e => inputHandler(e.offsetX));
        container.addEventListener('touchmove', e => { e.preventDefault(); inputHandler(e.touches[0].clientX - container.getBoundingClientRect().left); }, {passive:false});
        container.addEventListener('mouseup', dropHandler);
        container.addEventListener('touchend', dropHandler);

        // [핵심] 충돌 로직 수정
        Events.on(engine, 'collisionStart', (event) => {
            event.pairs.forEach(pair => {
                const a = pair.bodyA, b = pair.bodyB;
                if (a.plugin && b.plugin && a.plugin.level !== undefined && a.plugin.level === b.plugin.level) {
                    // 이미 삭제 예정인 바디는 무시
                    if(a.isRemoved || b.isRemoved) return;
                    
                    const lvl = a.plugin.level;
                    if (lvl < PLANETS.length - 1) {
                        a.isRemoved = true; b.isRemoved = true; // 중복 처리 방지 플래그
                        World.remove(world, [a, b]);
                        
                        const midX = (a.position.x + b.position.x) / 2;
                        const midY = (a.position.y + b.position.y) / 2;
                        
                        const newBody = createPlanetBody(midX, midY, lvl + 1, false);
                        World.add(world, newBody);
                        
                        score += PLANETS[lvl].s;
                        document.getElementById('scoreDisplay').innerText = score;
                        try{ 
                            const sfx = document.getElementById('sfx-merge');
                            sfx.currentTime=0; sfx.play(); 
                        }catch(e){}
                    }
                }
            });
        });

        // 게임 오버 체크
        setInterval(() => {
            if(isGameOver) return;
            Composite.allBodies(world).forEach(body => {
                if(!body.isStatic && body.position.y < 120 && body.velocity.y > -0.1 && body.velocity.y < 0.1 && body !== currentBody) {
                    isGameOver = true;
                    document.getElementById('finalScore').innerText = score;
                    document.getElementById('gameOverScreen').style.display = 'flex';
                }
            });
        }, 1000);
    </script>
</body>
</html>