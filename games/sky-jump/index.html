<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sky Jump V2 - 진화하는 하늘</title>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            margin: 0; padding: 0; background: #111; overflow: hidden; 
            font-family: 'Black Han Sans', sans-serif; touch-action: none;
            display: flex; justify-content: center; align-items: center; height: 100vh;
        }
        
        /* [핵심] 게임 화면 비율 고정 컨테이너 */
        #gameContainer {
            position: relative;
            width: 100%; max-width: 500px; /* PC에서는 너무 커지지 않게 */
            aspect-ratio: 9 / 16; /* 9:16 비율 고정 (틱톡/릴스 비율) */
            max-height: 100vh; /* 화면 높이에 맞춤 */
            background: #222;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            overflow: hidden;
        }

        /* 캔버스 */
        #gameCanvas { display: block; width: 100%; height: 100%; }

        /* UI 레이어 */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        .score-board {
            text-align: center; padding-top: 30px;
            color: white; font-size: 2.5rem; text-shadow: 2px 2px 0 #000;
        }
        .best-score { font-size: 1rem; color: #ccc; }

        /* 화면들 */
        #startScreen, #gameOverScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto; z-index: 10;
            text-align: center; color: white;
        }
        
        .btn {
            background: #00ff9d; color: black; border: none; padding: 15px 40px;
            font-size: 1.5rem; border-radius: 30px; cursor: pointer;
            font-family: 'Black Han Sans'; transition: 0.2s;
            box-shadow: 0 5px 0 #00b870; margin-top: 20px;
        }
        .btn:active { transform: translateY(5px); box-shadow: none; }
        
        /* 광고 영역 */
        .ad-area {
            pointer-events: auto; width: 320px; height: 100px; margin: 0 auto 20px auto;
        }

        .controls-hint {
            position: absolute; bottom: 140px; width: 100%;
            display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box;
            color: rgba(255,255,255,0.4); font-size: 1.8rem;
        }
    </style>
</head>
<body>

    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>

        <div class="ui-layer">
            <div class="score-board">
                <div id="scoreDisplay">0</div>
                <div class="best-score">BEST: <span id="bestDisplay">0</span></div>
            </div>
            
            <div class="ad-area" id="ad-game-bottom"></div>
            
            <div class="controls-hint" id="controlsHint">
                <span><i class="fa-solid fa-arrow-left"></i> 터치</span>
                <span>터치 <i class="fa-solid fa-arrow-right"></i></span>
            </div>
        </div>

        <div id="startScreen">
            <h1 style="font-size:3rem; margin-bottom:10px; color:#00ff9d;">SKY JUMP V2</h1>
            <p>좌우로 움직여서 떨어지지 말고 위로!</p>
            <p style="font-size:0.9rem; color:#aaa; margin-top:5px;">점수가 오르면 배경이 진화합니다</p>
            <button class="btn" onclick="startGame()">게임 시작</button>
        </div>

        <div id="gameOverScreen" style="display:none;">
            <h1 style="color:#ff4757; font-size:3rem;">GAME OVER</h1>
            <p style="font-size:1.5rem;">내 점수: <span id="finalScore">0</span></p>
            <button class="btn" onclick="resetGame()">다시 도전</button>
            <a href="../../index.html" style="color:#aaa; margin-top:20px; text-decoration:none; display:block;">홈으로 나가기</a>
        </div>
    </div>

    <audio id="bgm" src="../../audio/bgm_fast.mp3" loop></audio>
    <audio id="sfx-jump" src="../../audio/jump.mp3"></audio>
    <audio id="sfx-over" src="../../audio/gameover.mp3"></audio>

    <script src="../../js/ads.js"></script>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // 게임 내부 해상도 고정 (이 비율 안에서 그림을 그립니다)
        const GAME_WIDTH = 500;
        const GAME_HEIGHT = 900;
        canvas.width = GAME_WIDTH;
        canvas.height = GAME_HEIGHT;
        
        // 이미지 로드
        const imgPlayer = new Image(); imgPlayer.src = "../../images/sky-jump/player.png";
        const imgPlatform = new Image(); imgPlatform.src = "../../images/sky-jump/platform.png";
        
        // [신규 기능] 배경 이미지 3장 로드
        const bgImages = [];
        const bgSources = ["bg_stage1.png", "bg_stage2.png", "bg_stage3.png"];
        bgSources.forEach(src => {
            const img = new Image();
            img.src = `../../images/sky-jump/${src}`;
            bgImages.push(img);
        });
        
        let gameLoop;
        let score = 0;
        let bestScore = localStorage.getItem('skyJumpBestV2') || 0;
        let platforms = [];
        let isGameOver = false;
        
        const player = {
            x: GAME_WIDTH / 2 - 25, y: GAME_HEIGHT - 150, width: 60, height: 60, // 캐릭터 크기 (살짝 키움)
            dx: 0, dy: 0, speed: 7, jumpPower: -15, gravity: 0.6
        };

        const keys = { left: false, right: false };

        document.getElementById('bestDisplay').innerText = bestScore;

        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            const bgm = document.getElementById('bgm'); bgm.volume = 0.3; bgm.play().catch(()=>{});
            resetGame();
        }

        function resetGame() {
            document.getElementById('gameOverScreen').style.display = 'none';
            score = 0;
            document.getElementById('scoreDisplay').innerText = score;
            player.dy = 0;
            player.y = GAME_HEIGHT - 150;
            player.x = GAME_WIDTH / 2 - player.width / 2;
            platforms = [];
            isGameOver = false;
            platforms.push({ x: GAME_WIDTH/2 - 50, y: GAME_HEIGHT - 60, w: 100, h: 25 }); // 시작 발판
            generatePlatforms(GAME_HEIGHT - 150);
            if(gameLoop) cancelAnimationFrame(gameLoop);
            gameLoop = requestAnimationFrame(update);
        }

        function generatePlatforms(startY) {
            for (let i = 0; i < 15; i++) {
                let y = startY - 80 - i * 90;
                let w = 80 + Math.random() * 40;
                let x = Math.random() * (GAME_WIDTH - w);
                platforms.push({ x: x, y: y, w: w, h: 25 });
            }
        }

        function update() {
            if (isGameOver) return;
            ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            
            // [배경 진화 로직] 50점마다 배경 변경
            let bgIndex = Math.floor(score / 50); 
            if (bgIndex >= bgImages.length) bgIndex = bgImages.length - 1; // 마지막 배경 유지
            const currentBg = bgImages[bgIndex];
            
            if(currentBg && currentBg.complete) {
                // 비율 유지하며 배경 꽉 채우기 (Cover 방식)
                const scale = Math.max(GAME_WIDTH / currentBg.width, GAME_HEIGHT / currentBg.height);
                const x = (GAME_WIDTH / 2) - (currentBg.width / 2) * scale;
                const y = (GAME_HEIGHT / 2) - (currentBg.height / 2) * scale;
                ctx.drawImage(currentBg, x, y, currentBg.width * scale, currentBg.height * scale);
            } else {
                // 이미지 로딩 전엔 그라데이션
                const grad = ctx.createLinearGradient(0, 0, 0, GAME_HEIGHT);
                grad.addColorStop(0, "#2980b9"); grad.addColorStop(1, "#6dd5fa");
                ctx.fillStyle = grad; ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            }

            // 플레이어 이동
            if (keys.left) player.x -= player.speed;
            if (keys.right) player.x += player.speed;

            if (player.x + player.width < 0) player.x = GAME_WIDTH;
            else if (player.x > GAME_WIDTH) player.x = -player.width;

            player.dy += player.gravity;
            player.y += player.dy;

            // 충돌 처리
            platforms.forEach(p => {
                if (
                    player.dy > 0 &&
                    player.y + player.height > p.y &&
                    player.y + player.height < p.y + p.h + 15 &&
                    player.x + player.width > p.x + 10 &&
                    player.x < p.x + p.w - 10
                ) {
                    player.dy = player.jumpPower;
                    playSound('jump');
                }
                
                if(imgPlatform.complete) ctx.drawImage(imgPlatform, p.x, p.y, p.w, p.h);
                else { ctx.fillStyle = "#00ff9d"; ctx.fillRect(p.x, p.y, p.w, p.h); }
            });

            // 스크롤 (화면 올리기)
            if (player.y < GAME_HEIGHT / 2.5) {
                let diff = GAME_HEIGHT / 2.5 - player.y;
                player.y = GAME_HEIGHT / 2.5;
                
                platforms.forEach((p, index) => {
                    p.y += diff;
                    if (p.y > GAME_HEIGHT) {
                        platforms.splice(index, 1);
                        score++;
                        document.getElementById('scoreDisplay').innerText = score;
                        document.getElementById('controlsHint').style.display = 'none';

                        // 새 발판 생성
                        let highestY = platforms[platforms.length-1].y;
                        let y = highestY - 90;
                        let w = 80 + Math.random() * 40;
                        let x = Math.random() * (GAME_WIDTH - w);
                        platforms.push({ x: x, y: y, w: w, h: 25 });
                    }
                });
            }

            // 플레이어 그리기 (비율 유지됨!)
            if(imgPlayer.complete) ctx.drawImage(imgPlayer, player.x, player.y, player.width, player.height);
            else { ctx.fillStyle = "white"; ctx.fillRect(player.x, player.y, player.width, player.height); }

            // 게임 오버
            if (player.y > GAME_HEIGHT) {
                gameOver();
                return;
            }

            gameLoop = requestAnimationFrame(update);
        }

        function gameOver() {
            isGameOver = true;
            cancelAnimationFrame(gameLoop);
            playSound('over');
            document.getElementById('bgm').pause(); document.getElementById('bgm').currentTime = 0;

            if(score > bestScore) {
                bestScore = score;
                localStorage.setItem('skyJumpBestV2', bestScore);
                document.getElementById('bestDisplay').innerText = bestScore;
            }
            document.getElementById('finalScore').innerText = score;
            document.getElementById('gameOverScreen').style.display = 'flex';
        }

        function playSound(type) {
            const s = document.getElementById(type === 'jump' ? 'sfx-jump' : 'sfx-over');
            s.currentTime = 0; s.play().catch(()=>{});
        }

        // 조작
        window.addEventListener('keydown', e => {
            if(e.code === 'ArrowLeft') keys.left = true;
            if(e.code === 'ArrowRight') keys.right = true;
        });
        window.addEventListener('keyup', e => {
            if(e.code === 'ArrowLeft') keys.left = false;
            if(e.code === 'ArrowRight') keys.right = false;
        });
        window.addEventListener('touchstart', e => {
            e.preventDefault();
            if(e.touches[0].clientX < window.innerWidth / 2) keys.left = true; else keys.right = true;
        }, {passive: false});
        window.addEventListener('touchend', e => {
             e.preventDefault(); keys.left = false; keys.right = false;
        }, {passive: false});

    </script>
</body>
</html>
