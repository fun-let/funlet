<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sky Jump V5 - Fixed</title>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            margin: 0; padding: 0; background: #111; overflow: hidden; 
            font-family: 'Black Han Sans', sans-serif; touch-action: none;
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; height: 100dvh;
        }
        #gameContainer {
            position: relative; width: 100%; max-width: 500px;
            height: 100%; background: #222; overflow: hidden;
        }
        #gameCanvas { display: block; width: 100%; height: 100%; }
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* UI Î†àÏù¥Ïñ¥Îäî ÌÑ∞Ïπò ÌÜµÍ≥º */
            display: flex; flex-direction: column; justify-content: space-between; z-index: 10;
        }
        .score-board { text-align: center; padding-top: 10px; pointer-events: none; }
        #scoreDisplay { font-size: 3rem; color: #FFD700; text-shadow: 2px 2px 0 #000; margin: 0; }
        .best-score { font-size: 1rem; color: #fff; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px; }
        
        /* ÏãúÏûë/Í≤åÏûÑÏò§Î≤Ñ ÌôîÎ©¥ (z-indexÎ•º ÎÜíÏó¨ÏÑú ÏµúÏÉÅÎã®Ïóê Î∞∞Ïπò) */
        #startScreen, #gameOverScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto; /* Ïó¨Í∏∞Îäî ÌÑ∞Ïπò Í∞ÄÎä•Ìï¥Ïïº Ìï® */
            z-index: 50; text-align: center; color: white;
        }
        
        .btn {
            background: #00ff9d; color: black; border: none; padding: 15px 40px;
            font-size: 1.5rem; border-radius: 50px; cursor: pointer;
            font-family: 'Black Han Sans'; margin-top: 20px;
            box-shadow: 0 5px 0 #00b870; touch-action: manipulation;
        }
        
        .ad-area {
            pointer-events: auto; width: 320px; height: 100px; margin: 0 auto 10px auto;
            position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 20;
        }

        .controls-hint {
            position: absolute; bottom: 120px; width: 100%;
            display: flex; justify-content: space-between; padding: 0 20px;
            color: rgba(255,255,255,0.5); font-size: 2rem; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>

        <div class="ui-layer">
            <div class="score-board">
                <p id="scoreDisplay">0</p>
                <span class="best-score">BEST: <span id="bestDisplay">0</span></span>
            </div>
            <div class="controls-hint" id="controlsHint">
                <span>üëà L</span><span>R üëâ</span>
            </div>
            <div class="ad-area" id="ad-game-bottom"></div>
        </div>

        <div id="startScreen">
            <h1 style="font-size:3rem; margin:0; color:#00ff9d;">SKY JUMP</h1>
            <p>Î™®Î∞îÏùº: Ï¢åÏö∞ ÌÑ∞Ïπò<br>PC: Î∞©Ìñ•ÌÇ§</p>
            <button class="btn" onclick="startGame()">START</button>
        </div>

        <div id="gameOverScreen" style="display:none;">
            <h1 style="color:#ff4757; font-size:3rem;">GAME OVER</h1>
            <p style="font-size:1.5rem;">SCORE: <span id="finalScore">0</span></p>
            <button class="btn" onclick="resetGame()">RETRY</button>
            <a href="../../index.html" style="color:#aaa; margin-top:20px; display:block;">ÌôàÏúºÎ°ú</a>
        </div>
    </div>

    <audio id="bgm" src="../../audio/bgm_fast.mp3" loop></audio>
    <audio id="sfx-jump" src="../../audio/jump.mp3"></audio>
    <audio id="sfx-over" src="../../audio/gameover.mp3"></audio>
    <script src="../../js/ads.js"></script>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const GAME_WIDTH = 500;
        const GAME_HEIGHT = 900;
        
        function resizeCanvas() {
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            canvas.width = GAME_WIDTH;
            canvas.height = GAME_HEIGHT;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        const imgPlayer = new Image(); imgPlayer.src = "../../images/sky-jump/player.png";
        const imgPlatform = new Image(); imgPlatform.src = "../../images/sky-jump/platform.png";
        const imgStar = new Image(); imgStar.src = "../../images/sky-jump/star.png";
        const imgRocket = new Image(); imgRocket.src = "../../images/sky-jump/rocket.png";
        
        const bgImages = [];
        ["bg_stage1.png", "bg_stage2.png", "bg_stage3.png"].forEach(src => {
            const img = new Image(); img.src = `../../images/sky-jump/${src}`; bgImages.push(img);
        });

        let gameLoop;
        let score = 0;
        let bestScore = localStorage.getItem('skyJumpBestV3') || 0;
        let platforms = [];
        let items = [];
        let isGameOver = false;
        
        const player = { x: GAME_WIDTH / 2 - 40, y: GAME_HEIGHT - 150, width: 80, height: 60, dx: 0, dy: 0, speed: 9, jumpPower: -17, gravity: 0.65 };
        const keys = { left: false, right: false };
        document.getElementById('bestDisplay').innerText = bestScore;

        // [Ï§ëÏöî] Í≤åÏûÑ ÏãúÏûë Ìï®Ïàò (ÏïàÏ†ÑÏû•Ïπò Ï∂îÍ∞Ä)
        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            
            // Î™®Î∞îÏùº Ïò§ÎîîÏò§ Ïû¨ÏÉù Ïã§Ìå® Î∞©ÏßÄ (try-catch)
            try {
                const bgm = document.getElementById('bgm'); 
                bgm.volume = 0.3; 
                bgm.play().catch(e => console.log("Audio play failed (User interaction needed)", e));
            } catch(e) { console.log(e); }
            
            resetGame();
        }

        function resetGame() {
            document.getElementById('gameOverScreen').style.display = 'none';
            score = 0; document.getElementById('scoreDisplay').innerText = score;
            player.dy = 0; player.y = GAME_HEIGHT - 150; player.x = GAME_WIDTH / 2 - player.width / 2;
            platforms = []; items = []; isGameOver = false;
            platforms.push({ x: GAME_WIDTH/2 - 60, y: GAME_HEIGHT - 80, w: 120, h: 25 });
            generateContent(GAME_HEIGHT - 150);
            if(gameLoop) cancelAnimationFrame(gameLoop);
            gameLoop = requestAnimationFrame(update);
        }

        function generateContent(startY) {
            for (let i = 0; i < 15; i++) {
                let y = startY - 100 - i * 110; 
                let w = 90 + Math.random() * 50;
                let x = Math.random() * (GAME_WIDTH - w);
                platforms.push({ x: x, y: y, w: w, h: 25 });
                if (Math.random() < 0.3) {
                    let type = Math.random() < 0.8 ? 'star' : 'rocket';
                    items.push({ x: x + w/2 - 20, y: y - 50, w: 40, h: 40, type: type });
                }
            }
        }

        function update() {
            if (isGameOver) return;
            ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            
            let bgIndex = Math.floor(score / 500); 
            if (bgIndex >= bgImages.length) bgIndex = bgImages.length - 1;
            const currentBg = bgImages[bgIndex];
            if(currentBg && currentBg.complete) {
                const scale = Math.max(GAME_WIDTH / currentBg.width, GAME_HEIGHT / currentBg.height);
                const x = (GAME_WIDTH - currentBg.width * scale) / 2;
                const y = (GAME_HEIGHT - currentBg.height * scale) / 2;
                ctx.drawImage(currentBg, x, y, currentBg.width * scale, currentBg.height * scale);
            } else { ctx.fillStyle = "#87CEEB"; ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT); }

            if (keys.left) player.x -= player.speed;
            if (keys.right) player.x += player.speed;
            if (player.x + player.width < 0) player.x = GAME_WIDTH;
            else if (player.x > GAME_WIDTH) player.x = -player.width;
            player.dy += player.gravity; player.y += player.dy;

            platforms.forEach(p => {
                if (player.dy > 0 && player.y + player.height > p.y && player.y + player.height < p.y + p.h + 20 && player.x + player.width > p.x + 10 && player.x < p.x + p.w - 10) {
                    player.dy = player.jumpPower;
                }
                if(imgPlatform.complete) ctx.drawImage(imgPlatform, p.x, p.y, p.w, p.h);
                else { ctx.fillStyle = "#fff"; ctx.fillRect(p.x, p.y, p.w, p.h); }
            });
            
            for (let i = items.length - 1; i >= 0; i--) {
                let it = items[i];
                let img = it.type === 'star' ? imgStar : imgRocket;
                if(img.complete) ctx.drawImage(img, it.x, it.y, it.w, it.h);
                if (player.x < it.x + it.w && player.x + player.width > it.x && player.y < it.y + it.h && player.y + player.height > it.y) {
                    items.splice(i, 1);
                    if (it.type === 'star') score += 50; else if (it.type === 'rocket') player.dy = -40;
                    document.getElementById('scoreDisplay').innerText = score;
                }
            }

            if (player.y < GAME_HEIGHT / 2.5) {
                let diff = GAME_HEIGHT / 2.5 - player.y; player.y = GAME_HEIGHT / 2.5;
                platforms.forEach((p, index) => {
                    p.y += diff;
                    if (p.y > GAME_HEIGHT) {
                        platforms.splice(index, 1); score += 10;
                        document.getElementById('scoreDisplay').innerText = score;
                        document.getElementById('controlsHint').style.display='none';
                        let highestY = platforms[platforms.length-1].y;
                        let y = highestY - 110;
                        let w = 90 + Math.random() * 50;
                        let x = Math.random() * (GAME_WIDTH - w);
                        platforms.push({ x: x, y: y, w: w, h: 25 });
                        if (Math.random() < 0.3) {
                             let type = Math.random() < 0.8 ? 'star' : 'rocket';
                             items.push({ x: x + w/2 - 20, y: y - 50, w: 40, h: 40, type: type });
                        }
                    }
                });
                items.forEach((it, index) => { it.y += diff; if(it.y > GAME_HEIGHT) items.splice(index, 1); });
            }

            if(imgPlayer.complete) ctx.drawImage(imgPlayer, player.x, player.y, player.width, player.height);
            else { ctx.fillStyle = "lime"; ctx.fillRect(player.x, player.y, player.width, player.height); }

            if (player.y > GAME_HEIGHT) gameOver();
            else gameLoop = requestAnimationFrame(update);
        }

function gameOver() {
            isGameOver = true; 
            cancelAnimationFrame(gameLoop);
            document.getElementById('bgm').pause();
            
            if(score > bestScore) { 
                bestScore = score; 
                localStorage.setItem('skyJumpBestV3', bestScore); 
                document.getElementById('bestDisplay').innerText = bestScore; 
            }
            
            document.getElementById('finalScore').innerText = score;
            document.getElementById('gameOverScreen').style.display = 'flex';

            // ‚ñº‚ñº‚ñº [ÏàòÏ†ïÎêú ÏúÑÏπò] Í¥ÑÌò∏ Îã´Í∏∞ Ï†ÑÏóê ÎÑ£Ïñ¥Ïïº Ìï©ÎãàÎã§! ‚ñº‚ñº‚ñº
            if(window.showInterstitial) window.showInterstitial(); 
        }

        const handleDown = (left) => { if(left) keys.left = true; else keys.right = true; };
        const handleUp = () => { keys.left = false; keys.right = false; };
        
        window.addEventListener('keydown', e => { if(e.code==='ArrowLeft') handleDown(true); if(e.code==='ArrowRight') handleDown(false); });
        window.addEventListener('keyup', handleUp);
        
        // [Ï§ëÏöî] Î™®Î∞îÏùº ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏Í∞Ä Î≤ÑÌäº ÌÅ¥Î¶≠ÏùÑ Î∞©Ìï¥ÌïòÏßÄ ÏïäÎèÑÎ°ù Ï≤òÎ¶¨
        const container = document.getElementById('gameContainer');
        container.addEventListener('touchstart', e => {
            // ÏãúÏûë ÌôîÎ©¥Ïù¥ÎÇò Í≤åÏûÑÏò§Î≤Ñ ÌôîÎ©¥Ïù¥ Îñ†ÏûàÏúºÎ©¥ ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ Î¨¥Ïãú (Î≤ÑÌäº ÌÅ¥Î¶≠ Ïö∞ÏÑ†)
            if(document.getElementById('startScreen').style.display !== 'none' || 
               document.getElementById('gameOverScreen').style.display !== 'none') {
                return;
            }
            e.preventDefault();
            const touchX = e.touches[0].clientX;
            handleDown(touchX < window.innerWidth / 2);
        }, {passive: false});
        
        container.addEventListener('touchend', e => {
            if(document.getElementById('startScreen').style.display !== 'none' || 
               document.getElementById('gameOverScreen').style.display !== 'none') {
                return;
            }
            e.preventDefault(); handleUp();
        }, {passive: false});
    </script>
</body>
</html>
